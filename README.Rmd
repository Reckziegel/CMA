---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# CMA

<!-- badges: start -->

[![R-CMD-check](https://github.com/Reckziegel/CMA/workflows/R-CMD-check/badge.svg)](https://github.com/Reckziegel/CMA/actions) [![Codecov test coverage](https://codecov.io/gh/Reckziegel/CMA/branch/main/graph/badge.svg)](https://codecov.io/gh/Reckziegel/CMA?branch=main) [![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)

<!-- badges: end -->

> Multivariate Distribution = Marginals + Copulas

The Copula Marginal Algorithm (CMA) is a simple two step recipe to manipulate multivariate distributions under [Fully Flexible Probabilities](https://github.com/Reckziegel/FFP).

CMA can quickly decompose any multivariate distribution between unique (*marginals*) and their shared components (*copulas*). This approach can add a high level of flexibility for estimation and simulation purposes.

# Application 1: Panic Copulas

# Application 2: "What if" Analysis

Suppose you have an investment strategy and want to know different outcomes compatible with the strategy. One way of doing this is separating the marginals from the copulas, then generating large number of potential scenarios and "glue" back this outcomes into the empirical copula.

```{r}
library(cma)
library(tidyverse)
# log returns
x <- matrix(diff(log(EuStockMarkets)), ncol = 4)

# First CMA Step
step_one <- cma_separation(x)
step_one
```

Now that we have the decomposition done, let's generate 100 paths that comes from the student-t distribution:

```{r}
dist_t <- fit_t(step_one$marginal)
dist_t
```

```{r}
scenarios <- purrr::map(
    .x = rep(1859, 100), 
    .f = ~ generate_margins(model = dist_t, n = .x)
)
map(.x = scenarios, 
    .y = step_one, 
    .f = ~ suppressWarnings(
        cma_combination(x = .x$marginal, cdf = .y$cdf, copula = .y$copula)
    ) 
) |> 
    map(as.matrix) |> 
    map(~ . %*% rep(0.25, 4)) |> 
    map(as_tibble, .name_repair = "minimal") |> 
    bind_rows() |> 
    mutate(simulation = rep(1:100, each = 1859)) |> 
    group_by(simulation) |> 
    mutate(rowid = 1:1859) |> 
    mutate(ret = cumprod(exp(...1)), original = cumprod(exp(x %*% rep(0.25, 4)))) |> 
    ungroup() |> 
    ggplot(aes(x= rowid, y = ret, group = simulation)) +
    geom_line(color = 'grey') + 
    geom_line(mapping = aes(y = original)) + 
    scale_y_log10()
    
```
