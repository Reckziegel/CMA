---
title: "Panic Copula"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{panic_copula}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

As in [*A New Breed for Copulas for Risk and Portfolio Management*](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1752702), the CMA package offers tools to model events of "panic" (when the correlation among assets increases dramatically in downturns).

To implement the techniques in this vignette, the `EuStockMarkets` dataset is used.

```{r setup}
library(cma)
library(dplyr, warn.conflicts = FALSE)

# stationarity - "invariance"
x <- matrix(diff(log(EuStockMarkets)), ncol = 4)
colnames(x) <- colnames(EuStockMarkets)
head(x)
```

With `panic_copula()` it's possible to build a mixture of calm vs. panic environments. The "calm" market happens most of the time, while the "panic" event is triggered endogenously for a brief period - say 2% of the sample - after returns hit a certain quantile.

Because these events tends to push returns downward, `panic_copula()` uses entropy-pooling to rescale the series around zero, via minimum relative entropy.

```{r}
# For the details on how the market is modeled, please, see the paper: 
# "A New Breed for Copulas for Risk and Portfolio Management"
panic <- panic_copula(x, n = 50000, panic_cor = 0.97, panic_prob = 0.02, dist = "normal")
calm  <- panic_copula(x, n = 50000, panic_cor = 0.00, panic_prob = 0.00, dist = "normal")
```

We simulate `50.000` scenarios that matches the normal distribution exactly. In one scenario we assume there is a `2%` probability of panic, in which *all* the correlations go to `0.97`.

We also model a "calm" scenario assuming that history will repeat itself.

For simplicity, assume an equal-weight strategy for both simulations:

```{r}
# Equal-Weight Portfolio Under the Calm Market
pnl_panic <- tibble::tibble(
  pnl_panic = as.matrix(panic$simulation) %*% rep(0.25, 4)
)

# Equal-Weight Portgolio Under the Panic Market
pnl_calm <- tibble::tibble(
  pnl_calm = as.matrix(calm$simulation) %*% rep(0.25, 4)
)
```

The P&L can be seen with `plot_panic_distribution()`:

```{r, fig.align='center', fig.height=4, fig.width=7}
# PnL under the Panic Regime
plot_panic_distribution(pnl_panic, panic$p, breaks = 200)
```

The marginal distribution shows an agglomeration from probability mass around `-2%`, which is a direct consequence of the panic being instated.

The impact of a panic in the portfolio main statistics can be seen with help of `ggplot2`:

```{r, fig.align='center', fig.height=4, fig.width=7}
stats_panic <- empirical_stats(pnl_panic)
stats_calm  <- empirical_stats(pnl_calm)

bind_rows(stats_panic, stats_calm) |> 
  ggplot2::ggplot(ggplot2::aes(x = stat, y = value, fill = name)) + 
  ggplot2::geom_col(position = "dodge") +
  ggplot2::facet_wrap(~ stat, scales = "free") + 
  ggplot2::labs(x = NULL, y = NULL, fill = "regime")
```

While the location and dispersion doesn't change, the other metrics increases for markets that operate under binary regimes.

`panic_copula()` allow the user to price this impact: in our example, a 2% probability of panic increases the VaR and CVaR by 10%.
